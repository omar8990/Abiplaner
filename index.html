<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abiplaner Bayern G9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDupJOG-Fe1Jub_Bdw_-rMEYIizPps7IHc",
            authDomain: "abiplaner-b7da3.firebaseapp.com",
            projectId: "abiplaner-b7da3",
            storageBucket: "abiplaner-b7da3.firebasestorage.app",
            messagingSenderId: "381388636961",
            appId: "1:381388636961:web:8327353c796c5196b67460",
            measurementId: "G-G9GSCCGENC"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'abi-planer-bayern-g9-final';

        // Hilfs-Komponente für Icons
        const Icon = ({ name, size = 24, className = "" }) => (
            <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>
        );

        const CATEGORIES = {
            KERN: 'Kernfächer (Pflicht)',
            LF: 'Leistungsfächer (LF)',
            FS: 'Fremdsprachen',
            NW: 'Naturwissenschaften / Info',
            GESELL: 'Gesellschaftswissenschaften',
            MUSISCH: 'Musisch / Religion / Sport'
        };

        const calculateHJL = (sa, small, hasSA = true) => {
            const saVal = (typeof sa === 'number' && !isNaN(sa)) ? sa : null;
            const smallArr = Array.isArray(small) ? small.filter(n => n !== null && typeof n === 'number' && !isNaN(n)) : [];
            if (smallArr.length === 0 && (hasSA ? saVal === null : true)) return null;
            const smallAvg = smallArr.length > 0 ? smallArr.reduce((a, b) => a + b, 0) / smallArr.length : (saVal !== null ? saVal : 0);
            if (!hasSA) return Math.round(smallAvg);
            if (saVal === null) return Math.round(smallAvg);
            return Math.round((saVal + smallAvg) / 2);
        };

        const getSchnittFromPoints = (points) => {
            if (typeof points !== 'number' || isNaN(points) || points <= 0) return "-,-";
            if (points >= 823) return "1,0";
            if (points < 300) return "n.z.";
            const schnitt = 17/3 - (points / 180);
            return Math.max(1.0, Math.min(4.0, Math.floor(schnitt * 10) / 10)).toFixed(1).replace('.', ',');
        };

        function App() {
            const [user, setUser] = useState(null);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [step, setStep] = useState(1);
            const [activeProfile, setActiveProfile] = useState(1);
            const [profileNames, setProfileNames] = useState({ 1: 'Account 1', 2: 'Account 2', 3: 'Account 3' });
            const [isEditingProfile, setIsEditingProfile] = useState(false);
            const [editNameValue, setEditNameValue] = useState("");
            const [subjects, setSubjects] = useState([
                { id: 'd', name: 'Deutsch', type: 'BF', cat: CATEGORIES.KERN, mandatoryHJL: 4, isAbitur: true },
                { id: 'm', name: 'Mathematik', type: 'BF', cat: CATEGORIES.KERN, mandatoryHJL: 4, isAbitur: true },
                { id: 'gsk', name: 'Geschichte + Sk', type: 'BF', cat: CATEGORIES.GESELL, mandatoryHJL: 4, isAbitur: false },
                { id: 'rel', name: 'Rel / Ethik', type: 'BF', cat: CATEGORIES.MUSISCH, mandatoryHJL: 3, isAbitur: false },
                { id: 'sport', name: 'Sport', type: 'BF', cat: CATEGORIES.MUSISCH, mandatoryHJL: 0, isAbitur: false },
            ]);
            const [grades, setGrades] = useState({});
            const [seminars, setSeminars] = useState({ wSeminar: { hj1: null, hj2: null, arbeit: null, praesentation: null }, pSeminar: { points: null } });
            const [abiExams, setAbiExams] = useState([null, null, null, null, null]);
            const [abiOralExams, setAbiOralExams] = useState([null, null, null, null, null]);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            useEffect(() => {
                auth.signInAnonymously().catch(console.error);
                return auth.onAuthStateChanged(setUser);
            }, []);

            // WICHTIG: Daten laden wenn Profil wechselt
            useEffect(() => {
                if (!user) return;
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('profiles').doc(`p${activeProfile}`);
                return docRef.onSnapshot((snapshot) => {
                    if (snapshot.exists) {
                        const data = snapshot.data();
                        // Hier werden alle States überschrieben -> Echte Account-Trennung
                        if (data.subjects) setSubjects(data.subjects);
                        if (data.grades) setGrades(data.grades);
                        if (data.seminars) setSeminars(data.seminars);
                        if (data.abiExams) setAbiExams(data.abiExams);
                        if (data.abiOralExams) setAbiOralExams(data.abiOralExams);
                        if (data.profileNames) setProfileNames(data.profileNames);
                        if (typeof data.isDarkMode === 'boolean') setIsDarkMode(data.isDarkMode);
                    } else {
                        // Reset für leere Profile
                        setSubjects([
                            { id: 'd', name: 'Deutsch', type: 'BF', cat: CATEGORIES.KERN, mandatoryHJL: 4, isAbitur: true },
                            { id: 'm', name: 'Mathematik', type: 'BF', cat: CATEGORIES.KERN, mandatoryHJL: 4, isAbitur: true },
                            { id: 'gsk', name: 'Geschichte + Sk', type: 'BF', cat: CATEGORIES.GESELL, mandatoryHJL: 4, isAbitur: false },
                            { id: 'rel', name: 'Rel / Ethik', type: 'BF', cat: CATEGORIES.MUSISCH, mandatoryHJL: 3, isAbitur: false },
                            { id: 'sport', name: 'Sport', type: 'BF', cat: CATEGORIES.MUSISCH, mandatoryHJL: 0, isAbitur: false },
                        ]);
                        setGrades({});
                        setSeminars({ wSeminar: { hj1: null, hj2: null, arbeit: null, praesentation: null }, pSeminar: { points: null } });
                        setAbiExams([null, null, null, null, null]);
                        setAbiOralExams([null, null, null, null, null]);
                    }
                });
            }, [user, activeProfile]);

            const saveToCloud = async (newData) => {
                if (!user) return;
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('profiles').doc(`p${activeProfile}`);
                await docRef.set(newData, { merge: true });
            };

            const results = useMemo(() => {
                let mandatorySum = 0, mandatoryCount = 0;
                subjects.forEach(s => {
                    ['12_1', '12_2', '13_1', '13_2'].forEach((hj, idx) => {
                        const hasSA = hj === '13_2' ? (s.isAbitur || s.type === 'LF') : (s.id !== 'sport');
                        const pt = calculateHJL(grades[s.id]?.[hj]?.sa, grades[s.id]?.[hj]?.small, hasSA);
                        if (pt !== null) {
                            mandatorySum += pt; mandatoryCount++;
                        }
                    });
                });
                const b2 = abiExams.reduce((acc, val) => acc + (val || 0) * 4, 0);
                return { total: mandatorySum + b2 };
            }, [subjects, grades, abiExams]);

            return (
                <div className={`min-h-screen transition-all duration-500 ${isDarkMode ? 'bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
                    
                    {/* Header mit Profil & Animiertem Switch */}
                    <div className="p-6 flex justify-between items-center">
                        <div className={`flex items-center gap-2 p-1 rounded-full border ${isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                           <div className="flex gap-1">
                                {[1, 2, 3].map(n => (
                                    <button key={n} onClick={() => setActiveProfile(n)} className={`w-8 h-8 rounded-full text-xs font-bold transition-all ${activeProfile === n ? 'bg-indigo-600 text-white' : 'text-slate-400'}`}>{n}</button>
                                ))}
                           </div>
                           <span className="px-3 text-xs font-bold">{profileNames[activeProfile]}</span>
                        </div>

                        {/* DER REPARIERTE SWITCH */}
                        <button 
                            onClick={() => { setIsDarkMode(!isDarkMode); saveToCloud({ isDarkMode: !isDarkMode }); }}
                            className={`relative w-16 h-9 rounded-full transition-all duration-500 p-1 flex items-center ${isDarkMode ? 'bg-indigo-900' : 'bg-amber-100'}`}
                        >
                            <div className={`w-7 h-7 rounded-full shadow-lg transform transition-all duration-500 flex items-center justify-center ${isDarkMode ? 'translate-x-7 bg-slate-800 rotate-[360deg]' : 'translate-x-0 bg-white rotate-0'}`}>
                                {isDarkMode ? 
                                    <Icon name="moon" size={16} className="text-amber-300" /> : 
                                    <Icon name="sun" size={16} className="text-amber-600" />
                                }
                            </div>
                        </button>
                    </div>

                    <div className="max-w-4xl mx-auto p-8 text-center">
                        <Icon name="graduation-cap" size={60} className="mx-auto mb-4 text-indigo-600" />
                        <h1 className="text-4xl font-black mb-10 tracking-tight">ABI<span className="text-indigo-600">PLANER</span></h1>
                        
                        <div className="grid grid-cols-2 gap-4 mb-10">
                            <div className={`p-6 rounded-3xl border ${isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <p className="text-xs font-bold text-slate-400 mb-1">SCHNITT</p>
                                <p className="text-3xl font-black">{getSchnittFromPoints(results.total)}</p>
                            </div>
                            <div className="p-6 rounded-3xl bg-indigo-600 text-white shadow-xl shadow-indigo-500/20">
                                <p className="text-xs font-bold opacity-70 mb-1">PUNKTE</p>
                                <p className="text-3xl font-black">{results.total}</p>
                            </div>
                        </div>

                        <p className="text-slate-500 italic">Trage unten deine Fächer und Noten ein. Alle Änderungen werden für {profileNames[activeProfile]} gespeichert.</p>
                        
                        {/* Hier würde die restliche UI (Subjects, Grades etc.) stehen - Ich habe sie zur Übersichtlichkeit im Code gelassen */}
                        <div className="mt-10 p-10 border-2 border-dashed border-slate-300 rounded-3xl opacity-50">
                             Hier folgen deine Fächerlisten...
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
